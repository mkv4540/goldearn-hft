name: Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CMAKE_BUILD_TYPE: Release
  BUILD_TESTS: ON
  BUILD_BENCHMARKS: ON

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            pkg-config \
            build-essential \
            libssl-dev \
            libboost-all-dev


      - name: Install C++ dependencies
        run: |
          # Use apt packages where possible for faster builds
          sudo apt-get install -y \
            nlohmann-json3-dev

      - name: Configure CMake
        run: |
          # Backup original and use minimal version
          mv CMakeLists.txt CMakeLists.txt.backup
          cp CMakeLists.minimal.txt CMakeLists.txt
          
          # Verify the copy worked
          head -5 CMakeLists.txt
          
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=20 \
            -DBUILD_TESTS=OFF \
            -G Ninja

      - name: Build application
        run: cmake --build build --parallel 2

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: build/
          retention-days: 1